{% extends 'admin/base.html' %}

{% block head %}
    <!-- Thêm các tài nguyên Chart.js và Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block body %}
    {% if current_user.is_authenticated %}
        <div class="container mt-4">
            <h2 class="text-center mb-4">Báo cáo chuyến bay</h2>
            <canvas id="flightChart"></canvas>
        </div>

        <script>
            async function fetchData(url) {
                const response = await fetch(url);
                return response.json();
            }

            async function setupChart() {
                const [domestic, international] = await Promise.all([
                    fetchData('/datachuyenbaynoidia'),
                    fetchData('/datachuyenbaynuocngoai')
                ]);

                const ctx = document.getElementById('flightChart').getContext('2d');
                const domesticData = domestic.chuyenBayNoiDia.map(flight => ({
                    x: flight.maChuyenBay,
                    y: new Date(flight.thoiGian).getTime(),
                    type: 'Nội địa'
                }));

                const internationalData = international.chuyenBayNuocNgoai.map(flight => ({
                    x: flight.maChuyenBay,
                    y: new Date(flight.thoiGian).getTime(),
                    type: 'Quốc tế'
                }));

                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        datasets: [
                            {
                                label: 'Chuyến bay Nội địa',
                                data: domesticData,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Chuyến bay Quốc tế',
                                data: internationalData,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                },
                                title: {
                                    display: true,
                                    text: 'Mã chuyến bay'
                                }
                            },
                            y: {
                                type: 'linear',
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Thời gian'
                                }
                            }
                        }
                    }
                });
            }

            document.addEventListener('DOMContentLoaded', setupChart);
        </script>
    {% else %}
        <div class="alert alert-danger" role="alert">
            Bạn cần đăng nhập để xem báo cáo này.
        </div>
    {% endif %}
{% endblock %}
